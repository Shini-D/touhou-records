---
import { getRelativeLocaleUrl } from 'astro:i18n';
import config from '@/../astro.config.mjs';
import { getCurrentPathname } from '@/utils/currentPathname';

type Props = {
  classes: string;
  name: string;
  postUrl?: {en?: string, es?: string};
}

const locales: string[] = config.i18n?.locales ?? [''];
const selectLocales = locales.filter(locale => locale !== Astro.currentLocale);
const currentPage = getCurrentPathname(Astro.url.pathname);

const { classes='', name, postUrl={} } = Astro.props;

function setUrl(locale: string, currentPage: string, postUrl: {en?: string, es?: string}) {
  let path = (Object.keys(postUrl).length > 0) ?
    `/blog/${postUrl[locale as keyof typeof postUrl]}` :
    currentPage;
  return getRelativeLocaleUrl(locale, path)
}
---
<div class={`relative ${classes}`}>
  <button type="button" aria-controls={`lang-options-${name}`} aria-expanded="false" class="lang-switcher p-2 rounded uppercase w-full flex justify-center items-center bg-pearl-600 dark:bg-dark-300 hover:bg-pearl-500 hover:dark:bg-dark-200 aria-expanded:bg-pearl-500 aria-expanded:dark:bg-dark-200 group transition-colors cursor-pointer">
    {Astro.currentLocale}
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" class="group-aria-expanded:rotate-180 transition-transform">
      <path fill-rule="evenodd" clip-rule="evenodd" d="M10.5892 13.0892C10.4329 13.2454 10.221 13.3332 10 13.3332C9.77903 13.3332 9.56711 13.2454 9.41083 13.0892L4.69667 8.375C4.61708 8.29813 4.55359 8.20617 4.50992 8.1045C4.46624 8.00283 4.44325 7.89348 4.44229 7.78284C4.44133 7.67219 4.46242 7.56245 4.50432 7.46004C4.54622 7.35763 4.60809 7.26458 4.68634 7.18634C4.76458 7.10809 4.85763 7.04622 4.96004 7.00432C5.06245 6.96242 5.17219 6.94133 5.28284 6.94229C5.39348 6.94325 5.50283 6.96624 5.6045 7.00992C5.70617 7.05359 5.79813 7.11708 5.875 7.19667L10 11.3217L14.125 7.19667C14.2822 7.04487 14.4927 6.96087 14.7112 6.96277C14.9297 6.96467 15.1387 7.05231 15.2932 7.20682C15.4477 7.36133 15.5353 7.57034 15.5372 7.78883C15.5391 8.00733 15.4551 8.21783 15.3033 8.375L10.5892 13.0892Z" fill="currentColor"/>
    </svg>
  </button>
  <ul id={`lang-options-${name}`} class="lang-options absolute top-[calc(100%+var(--spacing))] right-0 bg-pearl-600 dark:bg-dark-300 rounded p-1 min-w-full uppercase opacity-0 pointer-events-none transition-opacity z-0">
    {selectLocales.map(locale => (
      <li>
        <a class="block text-center hover:bg-pearl-500 hover:dark:bg-dark-200 hover:dark:text-light transition-colors px-2 py-0.5" href={setUrl(locale, currentPage, postUrl)}>{locale}</a>
      </li>
    ))}
  </ul>
</div>

<script>
  document.addEventListener("astro:page-load", () => {
    const langSwitchers = document.querySelectorAll('.lang-switcher');
    const langOptions = document.querySelectorAll('.lang-options');

    if(langSwitchers.length > 0 && langOptions.length > 0){
      function handleLangSwitcher(event: Event) {
        const switcher = event.currentTarget as HTMLElement;
        const options = document.getElementById(switcher?.getAttribute('aria-controls') as string);
        if (!options) return;
        const expanded = switcher?.getAttribute('aria-expanded') === 'true';
        switcher?.setAttribute('aria-expanded', (!expanded).toString());
        options?.classList.toggle('opacity-0');
        options?.classList.toggle('pointer-events-none');
      }
      langSwitchers.forEach(switcher => {
        switcher.addEventListener('click', handleLangSwitcher);
      })
    }
  });
</script>
